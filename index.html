<!DOCTYPE html>
<html lang='vi'>
<head>
<meta charset='UTF-8' />
<meta name='viewport' content='width=device-width, initial-scale=1.0' />
<title>Bảng nhập hàng offline</title>
<style>
*{box-sizing:border-box;font-family:Arial,sans-serif;}
body{margin:20px;background:#f5f5f5;}
h1{font-size:22px;margin-bottom:10px;}
.toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px;align-items:center;}
label{font-size:14px;}
select,button{padding:5px 8px;font-size:14px;}
button{cursor:pointer;border-radius:4px;border:1px solid #ccc;background:#fff;}
button:hover{background:#eaeaea;}
#table-wrapper{background:#fff;padding:8px;border-radius:6px;box-shadow:0 0 4px rgba(0,0,0,0.1);overflow-x:auto;}
#supplierNameDisplay{font-weight:bold;margin-bottom:6px;font-size:14px;}
table{width:100%;border-collapse:collapse;}
thead{background:#f0f0f0;}
th,td{border:1px solid #ddd;padding:4px 6px;font-size:12px;text-align:left;}
th{text-align:center;font-weight:bold;}
td[contenteditable='true']{background-color:#fffef7;outline:none;}
.number-input{width:65px;text-align:right;}
.center{text-align:center;}
.narrow{width:40px;}
.col-qty{width:60px;}
.col-unit{width:60px;}
.col-stock{width:65px;}
.col-needed{width:80px;}
.note-col{min-width:90px;max-width:130px;}
.col-product{
  max-width:220px;
  word-wrap:break-word;
  white-space:normal;
}
.export-hide{display:none!important;}

/* Ẩn bớt khi in ra PDF */
@media print{
 body{margin:0;background:#fff;}
 .toolbar{display:none!important;}
 .col-stt,.col-stock,.col-needed{display:none!important;}
 #table-wrapper{box-shadow:none;border-radius:0;}
}

/* Mobile tối ưu cho iPhone Safari */
@media (max-width: 768px){
 body{margin:10px;}
 h1{font-size:18px;}
 th,td{font-size:11px;padding:3px 4px;}
 .toolbar{gap:6px;}
 select,button{padding:4px 6px;font-size:12px;}
 .number-input{width:55px;}
 .col-qty{width:55px;}
 .col-unit{width:50px;}
 .col-stock{width:55px;}
 .col-needed{width:65px;}
 .note-col{min-width:70px;max-width:100px;}
 .col-product{
   max-width:160px;
 }
}

/* Xóa viền input khi in PDF */
@media print{
  input{
    border:none!important;
    outline:none!important;
    background:transparent!important;
  }
}

/* Xóa viền input trên bản clone khi xuất ảnh PNG */
#table-wrapper-export input{
  border:none!important;
  outline:none!important;
  background:transparent!important;
}

tr.selected {
  background-color:#ffe2e2!important;
}
</style>
</head>
<body>
<h1>Bảng Nhập Hàng ( Thành Hương - Nghệ An )</h1>

<div class='toolbar'>
  <label for='supplierSelect'>NCC:</label>
  <select id='supplierSelect'></select>

  <button id='btnAddSupplier'>+ NCC</button>
  <button id='btnRenameSupplier'>Sửa NCC</button>
  <button id='btnDeleteSupplier'>Xóa NCC</button>

  <button id='btnAddRow'>+ Dòng</button>
  <button id='btnDeleteRow'>Xoá dòng</button>
  <button id='btnExportPDF'>PDF</button>
  <button id='btnExportStockPDF'>PDF tồn</button>
  <button id='btnExportImage'>Ảnh</button>
</div>

<div id='table-wrapper'>
  <div id='supplierNameDisplay'>(chưa chọn)</div>
  <table id='importTable'>
    <thead>
      <tr>
        <th class='narrow col-stt'>#</th>
        <th class='col-product'>Sản phẩm</th>
        <th class='col-qty'>SL</th>
        <th class='col-unit'>ĐVT</th>
        <th class='col-stock'>Tồn</th>
        <th class='col-needed'>Cần có</th>
        <th class='note-col'>Ghi chú</th>
      </tr>
    </thead>
    <tbody id='tableBody'></tbody>
  </table>
</div>

<script src='https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js'></script>

<script>
// ====== CẤU HÌNH LƯU LOCALSTORAGE ======
const STORAGE_KEY = 'bangNhapHang_v1';

// Dữ liệu mẫu ban đầu
let supplierData = {
  'Nhà cung cấp A': [
    {name:'Sữa tươi',unit:'Hộp',qty:'',stock:'',needed:'',note:''},
    {name:'Nước khoáng',unit:'Chai',qty:'',stock:'',needed:'',note:''}
  ],
  'Nhà cung cấp B': [
    {name:'Mì tôm',unit:'Thùng',qty:'',stock:'',needed:'',note:''}
  ],
  'Nhà cung cấp C': [
    {name:'Coca',unit:'Lon',qty:'',stock:'',needed:'',note:''},
    {name:'Nước khoáng',unit:'Chai',qty:'',stock:'',needed:'',note:''},
    {name:'Nước 247',unit:'Chai',qty:'',stock:'',needed:'',note:''}
  ]
};

let currentSupplier = null;

const supplierSelect = document.getElementById('supplierSelect');
const tableBody = document.getElementById('tableBody');
const supplierNameDisplay = document.getElementById('supplierNameDisplay');
let selectedRow = null;

// ====== HÀM LƯU / TẢI LOCALSTORAGE ======
function loadFromStorage(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return false;
    const data = JSON.parse(raw);
    if(!data || !data.supplierData) return false;
    supplierData = data.supplierData;
    currentSupplier = data.currentSupplier || null;
    return true;
  }catch(e){
    console.warn('Không đọc được localStorage:', e);
    return false;
  }
}

function saveToStorage(){
  try{
    const payload = {
      supplierData,
      currentSupplier
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
  }catch(e){
    console.warn('Không lưu được localStorage:', e);
  }
}

// ====== KHỞI TẠO NHÀ CUNG CẤP ======
function initSuppliers(selectedName){
  const current = selectedName || currentSupplier;
  supplierSelect.innerHTML = '';
  Object.keys(supplierData).forEach(name=>{
    const opt=document.createElement('option');
    opt.value=name;
    opt.textContent=name;
    supplierSelect.appendChild(opt);
  });

  if (Object.keys(supplierData).length === 0) {
    currentSupplier = null;
    supplierNameDisplay.textContent = '(chưa chọn)';
    tableBody.innerHTML = '';
    return;
  }

  if (current && supplierData[current]) {
    supplierSelect.value = current;
    currentSupplier = current;
  } else {
    currentSupplier = Object.keys(supplierData)[0];
    supplierSelect.value = currentSupplier;
  }
}

function updateSupplierLabel(){
  const name = currentSupplier || '(chưa chọn)';
  supplierNameDisplay.textContent = name;
}

function createRow(index,productData){
  const tr=document.createElement('tr');

  const tdIndex=document.createElement('td');
  tdIndex.className='center col-stt';
  tdIndex.textContent=index;
  tr.appendChild(tdIndex);

  const tdProduct=document.createElement('td');
  tdProduct.className='col-product';
  tdProduct.contentEditable='true';
  tdProduct.textContent=productData?.name||'';
  tr.appendChild(tdProduct);

  const tdQty=document.createElement('td');
  tdQty.className='col-qty';
  const inputQty=document.createElement('input');
  inputQty.type='number';inputQty.min='0';inputQty.className='number-input';
  inputQty.value=productData?.qty ?? '';
  tdQty.appendChild(inputQty);
  tr.appendChild(tdQty);

  const tdUnit=document.createElement('td');
  tdUnit.className='col-unit';
  tdUnit.contentEditable='true';
  tdUnit.textContent=productData?.unit||'';
  tr.appendChild(tdUnit);

  const tdStock=document.createElement('td');
  tdStock.className='col-stock';
  const inputStock=document.createElement('input');
  inputStock.type='number';inputStock.min='0';inputStock.className='number-input';
  inputStock.value=productData?.stock ?? '';
  tdStock.appendChild(inputStock);
  tr.appendChild(tdStock);

  const tdNeeded=document.createElement('td');
  tdNeeded.className='col-needed';
  const inputNeeded=document.createElement('input');
  inputNeeded.type='number';inputNeeded.min='0';inputNeeded.className='number-input';
  inputNeeded.value=productData?.needed ?? '';
  tdNeeded.appendChild(inputNeeded);
  tr.appendChild(tdNeeded);

  const tdNote=document.createElement('td');
  tdNote.className='note-col';
  tdNote.contentEditable='true';
  tdNote.textContent=productData?.note || '';
  tr.appendChild(tdNote);

  return tr;
}

// Lưu dữ liệu từ bảng hiện tại vào supplierData cho NCC đang hiển thị
function saveCurrentSupplierData(){
  const name = currentSupplier;
  if (!name || !supplierData[name]) return;

  const rows = tableBody.querySelectorAll('tr');
  const arr = [];
  rows.forEach(row=>{
    const cells = row.querySelectorAll('td');
    const product = cells[1].textContent.trim();
    const qtyInput = cells[2].querySelector('input');
    const unit = cells[3].textContent.trim();
    const stockInput = cells[4]?.querySelector('input');
    const neededInput = cells[5]?.querySelector('input');
    const note = cells[6]?.textContent.trim() || '';

    arr.push({
      name: product,
      qty: qtyInput ? qtyInput.value : '',
      unit: unit,
      stock: stockInput ? stockInput.value : '',
      needed: neededInput ? neededInput.value : '',
      note: note
    });
  });
  supplierData[name] = arr;
  saveToStorage();
}

// Render bảng theo NCC đang hiển thị
function renderTableForSupplier(name){
  tableBody.innerHTML='';
  if (!name || !supplierData[name]) {
    updateSupplierLabel();
    return;
  }
  const products=supplierData[name]||[];
  products.forEach((p,i)=>tableBody.appendChild(createRow(i+1,p)));
  relabelIndex();
  updateSupplierLabel();
}

function relabelIndex(){
  const rows=tableBody.querySelectorAll('tr');
  rows.forEach((row,i)=>{
    const cell=row.querySelector('.col-stt');
    if(cell) cell.textContent=i+1;
  });
}

function addEmptyRow(){
  const count=tableBody.querySelectorAll('tr').length;
  tableBody.appendChild(createRow(count+1,{name:'',unit:'',qty:'',stock:'',needed:'',note:''}));
  relabelIndex();
  saveCurrentSupplierData();
}

// Đánh dấu các dòng không có số lượng để ẩn khi in PDF
function markRowsForExportPDF(){
  const rows = tableBody.querySelectorAll('tr');
  rows.forEach(row=>{
    const qtyInput = row.querySelector('td.col-qty input');
    const qty = qtyInput ? parseFloat(qtyInput.value || '0') : 0;
    if (qty > 0){
      row.classList.remove('export-hide');
    } else {
      row.classList.add('export-hide');
    }
  });
}

function clearExportMarksPDF(){
  const rows = tableBody.querySelectorAll('tr.export-hide');
  rows.forEach(row=>row.classList.remove('export-hide'));
}

function exportPDF(){
  saveCurrentSupplierData();
  markRowsForExportPDF();
  window.print();
  clearExportMarksPDF();
}


function exportStockPDF(){
  saveCurrentSupplierData();

  const name = currentSupplier || '';
  const rows = tableBody.querySelectorAll('tr');

  let htmlContent = `
  <html>
  <head>
    <meta charset="UTF-8" />
    <title>Danh sách tồn kho</title>
    <style>
      body{font-family:Arial,sans-serif;margin:20px;}
      h2{font-size:18px;margin-bottom:10px;}
      table{width:100%;border-collapse:collapse;}
      th,td{border:1px solid #333;padding:4px 6px;font-size:12px;text-align:left;}
      th{text-align:center;}
    </style>
  </head>
  <body>
    <h2>${name ? 'Nhà cung cấp: ' + name : 'Danh sách tồn kho'}</h2>
    <table>
      <thead>
        <tr>
          <th>Sản phẩm</th>
          <th>Tồn</th>
        </tr>
      </thead>
      <tbody>
  `;

  rows.forEach(row=>{
    const cells = row.querySelectorAll('td');
    if(cells.length < 5) return;
    const product = cells[1].textContent.trim();
    const stockInput = cells[4].querySelector('input');
    const stock = stockInput ? (stockInput.value || '') : '';
    if(!product && !stock) return;
    htmlContent += `
        <tr>
          <td>${product}</td>
          <td>${stock}</td>
        </tr>
    `;
  });

  htmlContent += `
      </tbody>
    </table>
  </body>
  </html>
  `;

  const printWindow = window.open('', '_blank');
  if(!printWindow) {
    alert('Trình duyệt chặn cửa sổ in. Hãy cho phép popup để in PDF.');
    return;
  }
  printWindow.document.open();
  printWindow.document.write(htmlContent);
  printWindow.document.close();
  printWindow.focus();
  printWindow.print();
}

// Xuất ảnh PNG mượt: clone bảng ra off-screen, xử lý trên bản clone
function exportImage(){
  const ok = confirm('Xuất ảnh PNG với các dòng có số lượng > 0?');
  if (!ok) return;

  saveCurrentSupplierData();

  const originalWrapper = document.getElementById('table-wrapper');
  const cloneWrapper = originalWrapper.cloneNode(true);
  cloneWrapper.id = 'table-wrapper-export';
  cloneWrapper.style.position = 'fixed';
  cloneWrapper.style.left = '-9999px';
  cloneWrapper.style.top = '0';
  document.body.appendChild(cloneWrapper);

  // Ẩn dòng không có số lượng trong bản clone
  const rows = cloneWrapper.querySelectorAll('tbody tr');
  rows.forEach(row=>{
    const qtyInput = row.querySelector('td.col-qty input');
    const qty = qtyInput ? parseFloat(qtyInput.value || '0') : 0;
    if (!(qty > 0)){
      row.style.display = 'none';
    }
  });

  // Ẩn các cột không cần trong bản clone: STT, Tồn, Cần có
  const hideSelectors = ['.col-stt', '.col-stock', '.col-needed'];
  hideSelectors.forEach(sel=>{
    cloneWrapper.querySelectorAll(sel).forEach(cell=>{
      cell.style.display = 'none';
    });
  });

  html2canvas(cloneWrapper).then(canvas=>{
    document.body.removeChild(cloneWrapper);
    const link=document.createElement('a');
    link.download='bang-nhap-hang.png';
    link.href=canvas.toDataURL('image/png');
    link.click();
  }).catch(err=>{
    document.body.removeChild(cloneWrapper);
    alert('Không thể xuất ảnh: '+err);
  });
}

// Quản lý nhà cung cấp: thêm / sửa tên / xóa
function addSupplier(){
  const newName = prompt('Nhập tên nhà cung cấp mới:');
  if (!newName) return;
  if (supplierData[newName]){
    alert('Tên nhà cung cấp đã tồn tại!');
    return;
  }
  if (currentSupplier) saveCurrentSupplierData();
  supplierData[newName] = [];
  currentSupplier = newName;
  initSuppliers(currentSupplier);
  renderTableForSupplier(currentSupplier);
  saveToStorage();
}

function renameSupplier(){
  const oldName = currentSupplier;
  if (!oldName){
    alert('Chưa có nhà cung cấp để sửa.');
    return;
  }
  const newName = prompt('Sửa tên nhà cung cấp:', oldName);
  if (!newName || newName === oldName) return;
  if (supplierData[newName]){
    alert('Tên nhà cung cấp mới đã tồn tại!');
    return;
  }
  saveCurrentSupplierData();
  supplierData[newName] = supplierData[oldName];
  delete supplierData[oldName];
  currentSupplier = newName;
  initSuppliers(currentSupplier);
  renderTableForSupplier(currentSupplier);
  saveToStorage();
}

function deleteSupplier(){
  const name = currentSupplier;
  if (!name){
    alert('Chưa có nhà cung cấp để xóa.');
    return;
  }
  if (!confirm('Xóa nhà cung cấp "'+name+'"?')) return;
  delete supplierData[name];
  currentSupplier = null;
  initSuppliers();
  if (supplierSelect.value){
    currentSupplier = supplierSelect.value;
    renderTableForSupplier(currentSupplier);
  } else {
    tableBody.innerHTML='';
    updateSupplierLabel();
  }
  saveToStorage();
}

// Khởi tạo
document.addEventListener('DOMContentLoaded',()=>{
  // Thử load dữ liệu cũ từ localStorage, nếu có thì dùng, không thì xài dữ liệu mẫu
  loadFromStorage();

  initSuppliers();
  if (supplierSelect.options.length>0){
    if (!currentSupplier) currentSupplier = supplierSelect.value;
    renderTableForSupplier(currentSupplier);
  } else {
    updateSupplierLabel();
  }

  supplierSelect.addEventListener('change',()=>{
    const previous = currentSupplier;
    if (previous) {
      saveCurrentSupplierData();
    }
    currentSupplier = supplierSelect.value;
    renderTableForSupplier(currentSupplier);
    saveToStorage();
  });

  document.getElementById('btnAddRow').addEventListener('click',addEmptyRow);
  document.getElementById('btnExportPDF').addEventListener('click',exportPDF);
  document.getElementById('btnExportImage').addEventListener('click',exportImage);
  document.getElementById('btnExportStockPDF').addEventListener('click',exportStockPDF);

  document.getElementById('btnAddSupplier').addEventListener('click',addSupplier);
  document.getElementById('btnRenameSupplier').addEventListener('click',renameSupplier);
  document.getElementById('btnDeleteSupplier').addEventListener('click',deleteSupplier);

  // Chọn dòng bằng cách click vào dòng
  tableBody.addEventListener('click',(e)=>{
    const tr = e.target.closest('tr');
    if (!tr) return;
    if (selectedRow) selectedRow.classList.remove('selected');
    selectedRow = tr;
    tr.classList.add('selected');
  });

  // Xoá dòng được chọn
  document.getElementById('btnDeleteRow').addEventListener('click',()=>{
    if (!selectedRow){
      alert('Chưa chọn dòng để xoá!');
      return;
    }
    selectedRow.remove();
    selectedRow = null;
    relabelIndex();
    saveCurrentSupplierData();
  });

  // Tự động lưu khi sửa số lượng / tồn / cần có
  tableBody.addEventListener('input',(e)=>{
    if(e.target.matches('input')){
      saveCurrentSupplierData();
    }
  });

  // Tự động lưu khi sửa nội dung ô text (sản phẩm, ĐVT, ghi chú)
  tableBody.addEventListener('blur',(e)=>{
    if(e.target.isContentEditable){
      saveCurrentSupplierData();
    }
  }, true);
});
</script>
</body>
</html>
